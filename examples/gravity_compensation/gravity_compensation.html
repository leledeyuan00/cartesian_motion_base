

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gravity Compensation &mdash; Cartesian Motion Base Library 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />

  
    <link rel="canonical" href="https://leledeyuan00.github.io/cartesian_motion_base/examples/gravity_compensation/gravity_compensation.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
      <script src="../../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Cartesian Motion Base Library
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/library_root.html">C++ API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Cartesian Motion Base Library</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Gravity Compensation</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/leledeyuan00/cartesian_motion_base/blob/master/docs/examples/gravity_compensation/gravity_compensation.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="gravity-compensation">
<h1>Gravity Compensation<a class="headerlink" href="#gravity-compensation" title="Link to this heading"></a></h1>
<p>We implemented a gravity compensation algorithm on cartesian controllers.
Gravity compenstation is important when the robot needs to work in different orientations.</p>
<p>This example shows how to calculate the parameters and how to configure the contollers.</p>
<section id="prequisites">
<h2>1. Prequisites<a class="headerlink" href="#prequisites" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Make sure you have a F/T sensor mounted on the robot flange, and publish its raw data on <code class="docutils literal notranslate"><span class="pre">cartesian_compliance_controller/ft_sensor_wrench</span></code> topic.</p></li>
<li><p>Check topic <code class="docutils literal notranslate"><span class="pre">cartesian_compliance_controller/current_wrench</span></code> to see the transformed wrench data is aligned with robot frame.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The cartesian controller will automatically transform the raw F/T sensor data to the base frame based on the urdf.</p></li>
<li><p>For dual-arm, please check their topic names.</p></li>
<li><p>Your robot base frame z axis should be aligned with the gravity direction.</p></li>
</ul>
</div>
</section>
<section id="recording-the-gravity-pose-and-wrench">
<h2>2. Recording the gravity pose and wrench<a class="headerlink" href="#recording-the-gravity-pose-and-wrench" title="Link to this heading"></a></h2>
<p>We provide a example script to record the data needed for gravity compensation see <code class="docutils literal notranslate"><span class="pre">cartesian_motion_tools/gravity_pose_record.py</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This script will move the robot to 7 different poses and record the end-effector pose and wrench data.
So please make sure these poses are reachable and safe for your robot, you can check it first on simulation.</p>
</div>
<section id="run-the-recording-script">
<h3>2.1 Run the recording script<a class="headerlink" href="#run-the-recording-script" title="Link to this heading"></a></h3>
<p>Open a new terminal and source your workspace:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span><span class="w"> </span>~/cmb_ws/install/setup.bash
ros2<span class="w"> </span>run<span class="w"> </span>cartesian_motion_tools<span class="w"> </span>gravity_pose_record<span class="w"> </span>--sim<span class="w"> </span>True<span class="w">  </span><span class="c1"># if you are using simulation</span>
</pre></div>
</div>
</section>
<section id="calculate-the-gravity-compensation-parameters">
<h3>2.2 Calculate the gravity compensation parameters<a class="headerlink" href="#calculate-the-gravity-compensation-parameters" title="Link to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ros2<span class="w"> </span>run<span class="w"> </span>cartesian_motion_tools<span class="w"> </span>gravity_compute
</pre></div>
</div>
<p>It will generates a file named <code class="docutils literal notranslate"><span class="pre">gravity_result.txt</span></code> under <code class="docutils literal notranslate"><span class="pre">~/.gravity_compensation/</span></code> directory.
Its content looks like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">force</span><span class="p">:</span>
<span class="p p-Indicator">[</span><span class="nv">-12.26039</span><span class="p p-Indicator">,</span><span class="nv">-9.02906</span><span class="p p-Indicator">,</span><span class="nv">-2.64165</span><span class="p p-Indicator">,</span><span class="nv">0.52321</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># [gravity on z axis reference to world frame, offset x, offset y, offset z]</span>
<span class="nt">torque</span><span class="p">:</span>
<span class="p p-Indicator">[</span><span class="nv">0.04930</span><span class="p p-Indicator">,</span><span class="nv">-0.08519</span><span class="p p-Indicator">,</span><span class="nv">-0.10053</span><span class="p p-Indicator">,</span><span class="nv">0.23747</span><span class="p p-Indicator">]</span><span class="w">   </span><span class="c1"># [center of mass reference to end-effector, offset x, offset y, offset z]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can find this algorithm on this paper:
D. Chen, Y. Zhang, W. He, A. E. Petrilli Barcel´o, J. V. Salazar Luces, and Y. Hirata, “Simplified offset and gravity compensation for wrist-mounted force/torque sensor with a garment manipulation application,” in 2025 IEEE Int. Conf. on Robot. and Biomimetics (ROBIO), 2025</p>
</div>
</section>
</section>
<section id="configure-the-cartesian-controller">
<h2>3. Configure the cartesian controller<a class="headerlink" href="#configure-the-cartesian-controller" title="Link to this heading"></a></h2>
<p>Reference the example controller configuration file: <code class="docutils literal notranslate"><span class="pre">cartesian_motion_sim/cartesian_sim_bringup/config/cartesian_gazebo_controllers_sa.yaml</span></code>
Make changes to your robot controller configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">cartesian_compliance_controller</span><span class="p">:</span>
<span class="w">    </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">        </span><span class="nt">ik_solver</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;forward_dynamics&quot;</span>
<span class="w">        </span><span class="nt">end_effector_link</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tool0&quot;</span>
<span class="w">        </span><span class="nt">robot_base_link</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;robot_base_link&quot;</span>
<span class="w">        </span><span class="nt">ft_sensor_ref_link</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tool0&quot;</span>
<span class="w">        </span><span class="nt">compliance_ref_link</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tool0&quot;</span>
<span class="w">        </span><span class="nt">force_enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># Make sure you got the correct F/T sensor data</span>
<span class="w">        </span><span class="nt">gravity_compensation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w">  </span><span class="c1"># Set to true to enable gravity compensation</span>
<span class="w">            </span><span class="c1"># Copy your results here</span>
<span class="w">            </span><span class="nt">force</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">-12.26039</span><span class="p p-Indicator">,</span><span class="nv">-9.02906</span><span class="p p-Indicator">,</span><span class="nv">-2.64165</span><span class="p p-Indicator">,</span><span class="nv">0.52321</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="nt">torque</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">0.04930</span><span class="p p-Indicator">,</span><span class="nv">-0.08519</span><span class="p p-Indicator">,</span><span class="nv">-0.10053</span><span class="p p-Indicator">,</span><span class="nv">0.23747</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">force_state_pub</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># Set to true when use the real robot</span>
<span class="w">        </span><span class="nt">emergency_stop_threshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200.0</span>
<span class="w">        </span><span class="nt">joints</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shoulder_pan_joint</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shoulder_lift_joint</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">elbow_joint</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wrist_1_joint</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wrist_2_joint</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wrist_3_joint</span>

<span class="w">        </span><span class="c1"># Choose: position or velocity.</span>
<span class="w">        </span><span class="nt">command_interfaces</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">position</span>
<span class="w">            </span><span class="l l-Scalar l-Scalar-Plain">#- velocity</span>

<span class="w">        </span><span class="nt">stiffness</span><span class="p">:</span><span class="w">  </span><span class="c1"># w.r.t. compliance_ref_link</span>
<span class="w">            </span><span class="nt">trans_x</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500.0</span>
<span class="w">            </span><span class="nt">trans_y</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500.0</span>
<span class="w">            </span><span class="nt">trans_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500.0</span>
<span class="w">            </span><span class="nt">rot_x</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span>
<span class="w">            </span><span class="nt">rot_y</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span>
<span class="w">            </span><span class="nt">rot_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span>

<span class="w">        </span><span class="nt">damping</span><span class="p">:</span>
<span class="w">            </span><span class="nt">trans_x</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">            </span><span class="nt">trans_y</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">            </span><span class="nt">trans_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">            </span><span class="nt">rot_x</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">            </span><span class="nt">rot_y</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">            </span><span class="nt">rot_z</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>

<span class="w">        </span><span class="nt">solver</span><span class="p">:</span>
<span class="w">            </span><span class="nt">forward_dynamics</span><span class="p">:</span>
<span class="w">            </span><span class="nt">link_mass</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span>
<span class="w">            </span><span class="nt">error_scale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">            </span><span class="nt">iterations</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">            </span><span class="nt">publish_state_feedback</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="w">        </span><span class="nt">pd_gains</span><span class="p">:</span>
<span class="w">            </span><span class="nt">trans_x</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="nt"> d</span><span class="p">:</span><span class="w"> </span><span class="nv">0.005</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">trans_y</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="nt"> d</span><span class="p">:</span><span class="w"> </span><span class="nv">0.005</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">trans_z</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="nv">0.1</span><span class="p p-Indicator">,</span><span class="nt"> d</span><span class="p">:</span><span class="w"> </span><span class="nv">0.005</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">rot_x</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="nv">0.5</span><span class="p p-Indicator">,</span><span class="nt"> d</span><span class="p">:</span><span class="w"> </span><span class="nv">0.0001</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">rot_y</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="nv">0.5</span><span class="p p-Indicator">,</span><span class="nt"> d</span><span class="p">:</span><span class="w"> </span><span class="nv">0.0001</span><span class="p p-Indicator">}</span>
<span class="w">            </span><span class="nt">rot_z</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">p</span><span class="p">:</span><span class="w"> </span><span class="nv">0.5</span><span class="p p-Indicator">,</span><span class="nt"> d</span><span class="p">:</span><span class="w"> </span><span class="nv">0.0001</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<dl class="simple">
<dt>For recording:</dt><dd><p>When using the real robot, first set <code class="docutils literal notranslate"><span class="pre">force_enable</span></code> to false, <code class="docutils literal notranslate"><span class="pre">gravity_compensation</span></code> to false, and <code class="docutils literal notranslate"><span class="pre">force_state_pub</span></code> to true.</p>
</dd>
<dt>After computed the gravity compensation:</dt><dd><p>Set <code class="docutils literal notranslate"><span class="pre">gravity_compensation</span></code> to true to enable it, check the topic <code class="docutils literal notranslate"><span class="pre">/cartesian_compliance_controller/current_wrench</span></code> to see if it is working.
When using the real robot, set <code class="docutils literal notranslate"><span class="pre">force_enable</span></code> to true to enable the F/T sensor, and <code class="docutils literal notranslate"><span class="pre">force_state_pub</span></code> to true.</p>
</dd>
</dl>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>For dual-arm robot:</dt><dd><p>Please reference the example scripts, then recording the dual-arm pose and wrench to calculate their gravity compensation parameters respectively.</p>
</dd>
</dl>
</div>
</section>
<section id="application-dragging-the-robot-by-hand">
<h2>4. Application: Dragging the robot by hand<a class="headerlink" href="#application-dragging-the-robot-by-hand" title="Link to this heading"></a></h2>
<p>After the gravity compensation is enabled, you can easily drag the robot even rotating arbitrarily.
For realizing this function, we just need set the target pose as same as the current pose in a loop, due to the compliance controller, the robot has a passive compliance behavior.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Some other tasks ...</span>

<span class="c1">// Trigger the dragging task by service flag</span>
<span class="n">task_pushback</span><span class="p">(</span><span class="n">TaskPtr</span><span class="p">(</span><span class="s">&quot;Wait for Service Trigger&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](){</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">service_flag_</span><span class="p">){</span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Service triggered, proceeding to next task.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">set_task_finished</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}));</span>

<span class="c1">// Dragging the robot by hand</span>
<span class="n">task_pushback</span><span class="p">(</span><span class="n">TaskPtr</span><span class="p">(</span><span class="s">&quot;Drag by hand&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">](){</span>
<span class="w">    </span><span class="n">geometry_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PoseStamped</span><span class="w"> </span><span class="n">current_pose</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_current_pose</span><span class="p">(</span><span class="s">&quot;ur&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Create pose map</span>
<span class="w">    </span><span class="n">PoseMap</span><span class="w"> </span><span class="n">pose_map</span><span class="p">;</span>
<span class="w">    </span><span class="n">pose_map</span><span class="p">[</span><span class="s">&quot;ur&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_pose</span><span class="p">;</span>
<span class="w">    </span><span class="n">set_target_pose</span><span class="p">(</span><span class="n">pose_map</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">service_flag_</span><span class="p">){</span>
<span class="w">        </span><span class="c1">// Keep this task until the service flag is false</span>
<span class="w">        </span><span class="n">set_task_finished</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}));</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Dayuan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>